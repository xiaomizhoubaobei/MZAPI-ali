name: Jest 测试

on:
  push:
    branches: [ "main", "master" ]
    paths:
      - "code/**"
      - "code/package.json"
  pull_request:
    branches: [ "main", "master" ]
    paths:
      - "code/**"
      - "code/package.json"
  workflow_dispatch:

permissions:
  contents: read
  pull-requests: write

jobs:
  test:
    name: 测试
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write

    strategy:
      fail-fast: false
      matrix:
        node-version: [18.x, 20.x, 22.x, 23.x]

    steps:
      # 0. 安全加固
      - name: 加固运行器（审计所有出站调用）
        uses: step-security/harden-runner@20cf305ff2072d973412fa9b1e3a4f227bda3c76 # v2.14.0
        with:
          egress-policy: audit

      # 1. 检出代码
      - name: 检出代码
        uses: actions/checkout@v4

      # 2. 设置 Node.js 环境
      - name: 设置 Node.js ${{ matrix.node-version }}
        uses: actions/setup-node@v4
        with:
          node-version: ${{ matrix.node-version }}
          cache: 'yarn'
          cache-dependency-path: code/yarn.lock

      # 3. 安装依赖
      - name: 安装依赖
        working-directory: code
        run: yarn install --frozen-lockfile

      # 4. 运行单元测试
      - name: 运行单元测试
        working-directory: code
        run: yarn test -- --passWithNoTests

      # 5. 运行测试覆盖率
      - name: 运行测试覆盖率
        working-directory: code
        run: yarn test:cov -- --passWithNoTests

      # 6. 上传覆盖率报告
      - name: 上传覆盖率报告
        uses: codecov/codecov-action@v4
        with:
          files: ./code/coverage/lcov.info
          flags: unittests
          name: codecov-umbrella
          fail_ci_if_error: false

      # 7. 上传覆盖率报告为构件
      - name: 上传覆盖率报告为构件
        uses: actions/upload-artifact@v4.6.1
        if: matrix.node-version == '23.x'
        with:
          name: coverage-report
          path: code/coverage/
          retention-days: 30

  e2e:
    name: E2E 测试
    runs-on: ubuntu-latest
    needs: test
    permissions:
      contents: read

    steps:
      # 0. 安全加固
      - name: 加固运行器（审计所有出站调用）
        uses: step-security/harden-runner@20cf305ff2072d973412fa9b1e3a4f227bda3c76 # v2.14.0
        with:
          egress-policy: audit

      # 1. 检出代码
      - name: 检出代码
        uses: actions/checkout@v4

      # 2. 设置 Node.js 环境
      - name: 设置 Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '23.x'
          cache: 'yarn'
          cache-dependency-path: code/yarn.lock

      # 3. 安装依赖
      - name: 安装依赖
        working-directory: code
        run: yarn install --frozen-lockfile

      # 4. 运行 E2E 测试
      - name: 运行 E2E 测试
        working-directory: code
        run: yarn test:e2e -- --passWithNoTests

      # 5. 上传 E2E 测试报告
      - name: 上传 E2E 测试报告
        uses: actions/upload-artifact@v4.6.1
        if: always()
        with:
          name: e2e-test-report
          path: code/test-results/
          retention-days: 30