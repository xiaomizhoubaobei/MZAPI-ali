# 此工作流使用的操作未经 GitHub 认证。它们由
# 第三方提供，并受单独的
# 服务条款、隐私政策和支持
# 文档约束。

name: 供应链安全评分

on:
  # 用于分支保护检查。仅支持默认分支。参见
  # https://github.com/ossf/scorecard/blob/main/docs/checks.md#branch-protection
  # 确保 Maintained 检查偶尔更新。参见
  # https://github.com/ossf/scorecard/blob/main/docs/checks.md#maintained
  branch_protection_rule:
  schedule:
    - cron: '35 9 * * 0'
  push:
    branches: [ "main" ]
  # 允许手动触发
  workflow_dispatch:
  # 当有pull_request事件发生时触发
  pull_request:
    branches: [ "main" ]

# 声明默认权限为只读。
permissions: read-all

jobs:
  analysis:
    name: Scorecard analysis
    runs-on: ubuntu-latest
    # `publish_results: true` 仅在从默认分支运行时有效。如果禁用，可以删除此条件。
    if: github.event.repository.default_branch == github.ref_name || github.event_name == 'pull_request'
    permissions:
      # 需要此权限将结果上传到代码扫描仪表板。
      security-events: write
      # 需要此权限发布结果并获取徽章（参见下方的 publish_results）。
      id-token: write
      # 如果在私有仓库中安装，请取消注释以下权限。
      # contents: read
      # actions: read

    steps:
      # 0. 安全加固
      - name: Harden the runner (Audit all outbound calls)
        uses: step-security/harden-runner@20cf305ff2072d973412fa9b1e3a4f227bda3c76 # v2.14.0
        with:
          egress-policy: audit

      # 1. 检出代码
      - name: "Checkout code"
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1
        with:
          persist-credentials: false

      # 2. 运行 Scorecard 分析
      - name: "Run analysis"
        uses: ossf/scorecard-action@f49aabe0b5af0936a0987cfb85d86b75731b0186 # v2.4.1
        with:
          # ========== 输出配置 ==========
          results_file: results.sarif  # 输出文件路径
          results_format: sarif  # 输出格式 [json, sarif]

          # ========== 认证配置 ==========
          repo_token: ${{ secrets.GITHUB_TOKEN }}  # GitHub token（默认为 github.token）
          # 如果需要在公共仓库上启用分支保护检查或在私有仓库上安装 Scorecard，
          # 请创建 PAT 并取消注释以下行：
          # repo_token: ${{ secrets.SCORECARD_TOKEN }}

          # ========== 发布配置 ==========
          publish_results: true  # 发布结果到 OpenSSF REST API
          internal_publish_base_url: "https://api.scorecard.dev"  # 发布结果的基础 URL（用于测试）

          # ========== 文件获取模式 ==========
          # archive: 使用 GitHub Archive API（默认）
          # git: 使用 git clone（如果您有标记为 export-ignore 的文件的 .gitattributes，请使用此模式）
          file_mode: archive

      # 3. 上传结果为构件（可选）
      # 注释掉将禁用运行结果以 SARIF 格式上传到仓库 Actions 标签页。
      - name: "上传构件"
        uses: actions/upload-artifact@4cec3d8aa04e39d1a68397de0c4cd6fb9dce8ec1 # v4.6.1
        with:
          name: SARIF file
          path: results.sarif
          retention-days: 5

      # 4. 上传到 GitHub 代码扫描仪表板（可选）
      # 注释掉将禁用结果上传到您的仓库代码扫描仪表板
      - name: "上传到代码扫描"
        uses: github/codeql-action/upload-sarif@5d4e8d1aca955e8d8589aabd499c5cae939e33c7 # v4.31.9
        with:
          sarif_file: results.sarif